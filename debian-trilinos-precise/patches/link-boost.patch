Description: fix underlinking errors with boost
Author: Nico Schl√∂mer <nico.schloemer@gmail.com>
Bug: https://software.sandia.gov/bugzilla/show_bug.cgi?id=5929
Last-Update: 2014-04-10
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
diff --git a/cmake/TPLs/FindTPLBoost.cmake b/cmake/TPLs/FindTPLBoost.cmake
index a3fd9de..4c3b234 100644
--- a/cmake/TPLs/FindTPLBoost.cmake
+++ b/cmake/TPLs/FindTPLBoost.cmake
@@ -55,9 +55,36 @@
 
 INCLUDE(TribitsTplDeclareLibraries)
 
-TRIBITS_TPL_DECLARE_LIBRARIES( Boost
-  REQUIRED_HEADERS boost/version.hpp boost/mpl/at.hpp
-  )
+# Try CMake's Boost finder.
+SET(BOOST_INCLUDEDIR ${Boost_INCLUDE_DIRS})
+SET(BOOST_LIBRARYDIR ${Boost_LIBRARY_DIRS})
+IF (TPL_FIND_SHARED_LIBS)
+  SET(Boost_USE_STATIC_LIBS FALSE)
+ELSE()
+  SET(Boost_USE_STATIC_LIBS TRUE)
+ENDIF()
+
+# Trilinos uses Boost's header-only libraries. However, Boost's bug #7085
+# <https://svn.boost.org/trac/boost/ticket/7085> induces a dependency to
+# Boost's system library in STK. See also Trilinos bug #5929
+# <https://software.sandia.gov/bugzilla/show_bug.cgi?id=5929>. To work around
+# the bug, require boost::system and use ${Boost_system_LIBRARY} in STK.
+FIND_PACKAGE(Boost COMPONENTS system REQUIRED)
+
+IF(Boost_FOUND)
+  # Boost found.
+  # Besides what is already set by the finder, also set the corresponding
+  # TPL variables.
+  # Don't set the LIBRARY variables as of the comment below.
+  SET(TPL_Boost_INCLUDE_DIRS "${Boost_INCLUDE_DIRS}")
+  SET(TPL_Boost_LIBRARIES "")
+  SET(TPL_Boost_LIBRARY_DIRS "")
+ELSE()
+  # Fallback: Use Tribits.
+  TRIBITS_TPL_DECLARE_LIBRARIES( Boost
+    REQUIRED_HEADERS boost/version.hpp boost/mpl/at.hpp
+    )
+ENDIF()
 
 # This broke trilinos configuration:
 #  REQUIRED_LIBS_NAMES "program_options"
diff --git a/packages/stk/stk_mesh/stk_mesh/base/CMakeLists.txt b/packages/stk/stk_mesh/stk_mesh/base/CMakeLists.txt
index 86d73f0..6e9e182 100644
--- a/packages/stk/stk_mesh/stk_mesh/base/CMakeLists.txt
+++ b/packages/stk/stk_mesh/stk_mesh/base/CMakeLists.txt
@@ -51,7 +51,7 @@ TRIBITS_ADD_LIBRARY(
   stk_mesh_base
   NOINSTALLHEADERS ${HEADERS} ${HEADERS_IMPL}
   SOURCES ${SOURCES} ${SOURCES_IMPL}
-  DEPLIBS stk_util_env stk_util_parallel
+  DEPLIBS stk_util_env stk_util_parallel ${Boost_SYSTEM_LIBRARY}
   )
 
 INSTALL(FILES ${HEADERS} DESTINATION
